# 硬體安裝與架設指南

## 1. 硬體物料清單 (BOM)

### 主要組件

| 項目 | 型號/規格 | 數量 | 預估價格 | 供應商建議 |
|-----|----------|------|---------|----------|
| **嵌入式運算平台** | Jetson Nano 4GB開發板 | 1 | $99 | NVIDIA官方 |
| **攝影模組** | USB 1080p@60fps 攝影機 | 1 | $50-80 | Logitech C920/C930e |
| **餵料執行器** | PWM可調餵料馬達組 | 1 | $30-50 | 自製或訂製 |
| **照明設備** | 6500K LED高棚燈 25W | 1 | $20-30 | 攝影器材商 |
| **控制電路** | MOSFET驅動模組 | 1 | $10-15 | Arduino相容模組 |

### 展示用組件

| 項目 | 型號/規格 | 數量 | 預估價格 | 用途 |
|-----|----------|------|---------|------|
| **氣泡產生器** | 6檔可調打氣機 | 1 | $20-30 | 模擬魚咬活動 |
| **氣泡盤** | 多孔氣泡石 | 1 | $5-10 | 產生均勻氣泡 |
| **背景襯布** | 黑色/深綠無反光布料 | 1m² | $10-15 | 提升影像對比 |
| **偏光鏡** | CPL偏光鏡 (相機口徑) | 1 | $15-25 | 減少水面反光 |
| **支架系統** | 可調高度相機支架 | 1 | $30-50 | 穩定安裝 |

### 輔助材料

- 杜邦線 (公母頭)
- 麵包板或PCB板
- 螺絲、螺母
- 防水接頭
- 電源供應器 (5V/12V)

## 2. 安裝架設流程

### 2.1 環境準備

1. **選擇安裝位置**
   - 穩定的桌面或支架
   - 避免震動干擾
   - 便於觀察和操作
   - 良好的通風環境

2. **電源規劃**
   ```
   主電源 220V AC
   ├── Jetson Nano (5V 4A)
   ├── LED照明 (12V 2A)
   ├── 餵料馬達 (12V 1A)
   └── 打氣機 (12V 0.5A)
   ```

3. **展示缸設置**
   ```
   展示缸尺寸建議: 60cm x 40cm x 30cm
   ├── 底部鋪設深色背景布
   ├── 注入清水 (深度15-20cm)
   ├── 安裝氣泡盤 (遠離餵料投點)
   └── 確保水質清澈透明
   ```

### 2.2 相機系統安裝

1. **支架安裝**
   ```bash
   # 相機安裝高度: 80-120cm
   # 俯視角度: 垂直向下 (90°)
   # 視野範圍: 覆蓋完整水面
   ```

2. **鏡頭調整**
   ```bash
   # 1. 安裝CPL偏光鏡
   # 2. 調整偏光角度至最佳減反光位置
   # 3. 手動對焦至清晰 (如支援)
   # 4. 固定所有調整螺絲
   ```

3. **連接測試**
   ```bash
   # 連接到Jetson Nano USB埠
   lsusb  # 確認設備識別
   
   # 測試影像
   python3 -c "
   import cv2
   cap = cv2.VideoCapture(0)
   ret, frame = cap.read()
   print(f'解析度: {frame.shape}' if ret else '相機錯誤')
   cap.release()
   "
   ```

### 2.3 照明系統安裝

1. **燈具位置**
   ```
   LED高棚燈安裝位置:
   ├── 水面斜上方 45° 角度
   ├── 距離水面 50-80cm
   ├── 避免直射相機鏡頭
   └── 確保照明均勻無陰影
   ```

2. **照明控制**
   ```python
   # GPIO控制照明開關 (可選)
   import Jetson.GPIO as GPIO
   
   LED_PIN = 19
   GPIO.setmode(GPIO.BOARD)
   GPIO.setup(LED_PIN, GPIO.OUT)
   GPIO.output(LED_PIN, GPIO.HIGH)  # 開燈
   ```

### 2.4 餵料系統安裝

1. **馬達安裝**
   ```
   餵料馬達安裝要求:
   ├── 出料口對準ROI_ring中心區域
   ├── 高度約水面上方 10-15cm
   ├── 確保餵料能均勻散佈
   └── 避免堵塞和卡料
   ```

2. **PWM連接**
   ```python
   # PWM信號連接圖
   Jetson Nano GPIO 18 → MOSFET Gate
   MOSFET Source → GND
   MOSFET Drain → 馬達負極
   馬達正極 → 12V電源正極
   12V電源負極 → GND (共地)
   ```

3. **測試控制**
   ```python
   # PWM控制測試
   from src.aqua_feeder.hardware.pwm_controller import PWMController
   
   pwm = PWMController(pin=18, frequency=1000, min_duty=20, max_duty=70)
   pwm.start(30)  # 30%占空比測試
   
   # 測試線性響應
   for duty in range(20, 71, 10):
       pwm.set_duty_cycle(duty)
       input(f"當前占空比: {duty}%, 觀察餵料量變化，按Enter繼續...")
   
   pwm.stop()
   ```

### 2.5 展示系統安裝

1. **氣泡系統**
   ```python
   # 氣泡盤位置設定
   氣泡盤安裝:
   ├── 距離餵料投點 20-30cm
   ├── 水面下方 5-10cm深度
   ├── 確保氣泡分佈均勻
   └── 調節打氣量模擬不同魚咬強度
   ```

2. **檔位控制**
   ```python
   # 3-bit GPIO控制8個檔位
   AIR_PINS = [20, 21, 22]  # GPIO引腳
   
   def set_airflow_level(level):  # 0-7檔
       for i, pin in enumerate(AIR_PINS):
           GPIO.output(pin, (level >> i) & 1)
   
   # 測試不同檔位
   for level in range(8):
       set_airflow_level(level)
       print(f"氣泡檔位: {level}")
       time.sleep(5)
   ```

## 3. 系統校正與驗證

### 3.1 視覺系統校正

1. **ROI區域標定**
   ```bash
   # 執行ROI校正工具
   python3 tools/roi_calibration.py
   
   # 手動調整ROI座標
   # roi_bub: 氣泡檢測區域 (餵料投點附近)
   # roi_ring: 環狀波紋檢測區域 (較大範圍)
   ```

2. **基線值設定**
   ```bash
   # 記錄靜水狀態基線值
   python3 tools/baseline_calibration.py --duration 60
   
   # 輸出基線參數:
   # ME0: 靜水動態能量基線
   # RSI0: 靜水頻譜指數基線
   ```

### 3.2 控制系統校正

1. **PWM響應測試**
   ```bash
   # 測試PWM線性響應
   python3 tools/pwm_linearity_test.py
   
   # 驗證20-70%範圍內線性特性
   # 記錄實際餵料量與PWM關係
   ```

2. **PI控制器調參**
   ```yaml
   # 在config/system_params.yaml中調整
   controller:
     pi_controller:
       Kp: 15.0    # 比例增益 (根據響應速度調整)
       Ki: 2.0     # 積分增益 (根據穩態誤差調整)
   ```

### 3.3 整體系統驗證

1. **相關性驗證**
   ```bash
   # 展示模式驗證
   python3 validation/demo_correlation.py
   
   # 步驟:
   # 1. 設定氣泡檔位0 (無氣泡)
   # 2. 記錄H值基線
   # 3. 逐步增加氣泡檔位至7
   # 4. 記錄各檔位對應H值
   # 5. 計算相關係數 (目標 ≥ 0.75)
   ```

2. **穩定性測試**
   ```bash
   # 長時間穩定性測試
   python3 validation/stability_test.py --duration 3600
   
   # 檢查項目:
   # - PWM振盪幅度 ≤ ±15%
   # - 系統無崩潰或重啟
   # - 記憶體使用穩定
   # - 溫度控制在安全範圍
   ```

## 4. 安全注意事項

### 4.1 電氣安全
- 所有220V線路須由合格電工安裝
- 使用漏電保護器
- 水電分離，防止短路
- 定期檢查線路絕緣

### 4.2 機械安全
- 餵料馬達加裝防護罩
- 支架安裝牢固防傾倒
- 旋轉部件遠離操作人員
- 急停開關易於觸及

### 4.3 系統安全
- 定期備份配置文件
- 監控系統溫度
- 設置硬體看門狗
- 異常自動降級機制

## 5. 維護保養

### 5.1 日常維護
```bash
# 每日檢查清單
□ 相機鏡頭清潔
□ 照明燈具工作正常
□ 餵料管道無堵塞
□ 系統日誌檢查
□ 水質保持清澈
```

### 5.2 週期維護
```bash
# 每週維護清單
□ 深度清潔展示缸
□ 檢查所有連接線
□ 校驗PWM輸出精度
□ 分析週報資料
□ 備份重要資料
```

### 5.3 月度維護
```bash
# 每月維護清單
□ 系統性能評估
□ 硬體老化檢查
□ 軟體更新升級
□ 安全性檢查
□ 制定改進計劃
```

## 6. 故障排除手冊

### 6.1 常見硬體故障

| 故障現象 | 可能原因 | 解決方案 |
|---------|---------|---------|
| 相機無法啟動 | USB連接鬆動/驅動問題 | 重新插拔/更新驅動 |
| PWM無響應 | GPIO權限/線路問題 | 檢查權限/測試電路 |
| 照明不穩定 | 電源供應不足 | 檢查電源容量 |
| 馬達異常 | 過載/機械卡死 | 檢查負載/清潔維護 |

### 6.2 軟體故障診斷
```bash
# 系統診斷工具
python3 tools/system_diagnostic.py

# 檢查項目:
# - 硬體連接狀態
# - 軟體模組完整性
# - 配置文件正確性
# - 系統資源使用
```

---

**重要提醒**: 
1. 首次安裝請嚴格按照步驟執行
2. 每個步驟完成後進行功能測試
3. 記錄所有參數調整過程
4. 建立詳細的維護記錄
5. 定期進行系統校正驗證
