# 智能水產養殖自動餵料控制系統 - 功能模塊對應說明

## 概述

本系統完全按照軟體需求書設計實現，包含硬體物料清單（BOM）、軟體功能模塊與參數設計、驗證方式與目標效果三大部分。

## 一、硬體物料清單（BOM）與軟體實現對應

### 1. 硬體組件與軟體模塊對應

| 硬體組件 | 需求書規格 | 對應軟體模塊 | 實現文件 |
|---------|------------|-------------|----------|
| 單鏡頭攝影模組 | 1080p/60fps，俯視拍攝 | `CameraInterface` | `src/aqua_feeder/hardware/camera_interface.py` |
| PWM可調餵料馬達/甩料器 | 20%-70%線性控制 | `PWMController` | `src/aqua_feeder/hardware/pwm_controller.py` |
| 控制板（MOSFET/驅動模組） | PWM驅動控制 | `GPIOController` | `src/aqua_feeder/hardware/gpio_controller.py` |
| 6500K LED高棚燈 | 照明控制 | `GPIOController.setup_led()` | 集成在GPIO控制器中 |
| 氣泡盤 + 打氣機 | 6檔可調，展示用 | `GPIOController.setup_airflow()` | 3-bit控制，支援8檔 |

### 2. 安裝與架設順序實現

```python
# 對應需求書的安裝架設流程
def startup_hardware(self):
    """符合需求書的硬體初始化流程"""
    # 1. 啟動相機 - 1080p/60fps設定
    self.camera.start_capture()
    
    # 2. 啟動PWM控制器 - 20%-70%範圍
    self.pwm_controller.start()
    
    # 3. 初始化LED照明 - 6500K高棚燈
    self.gpio_controller.setup_led(gpio_pin=19, brightness=80)
    
    # 4. 初始化氣泡盤 - 6檔可調（實際8檔）
    self.gpio_controller.setup_airflow(gpio_pins=[20, 21, 22])
```

## 二、軟體功能模塊與需求書對應

### 1. 影像前處理模塊

**需求書要求：**
- CLAHE：局部對比增強
- 直方圖匹配：展示缸 → 實池顏色域對齊
- ROI 切割：ROI_bub、ROI_ring

**實現模塊：** `ImageProcessor`
**文件位置：** `src/aqua_feeder/vision/image_processor.py`

**核心功能：**
```python
def preprocess_image(self, image):
    """對應需求書的影像前處理"""
    # CLAHE增強
    enhanced = self.clahe.apply(gray)
    
    # 直方圖匹配（如果啟用）
    if self.reference_hist is not None:
        enhanced = self._histogram_matching(enhanced)
    
    # 提取ROI區域
    rois = self._extract_rois(enhanced)
    
    return enhanced, rois
```

### 2. 特徵提取模塊

**需求書要求：**
- ME（Motion Energy）：動態能量
- RSI（Ripple Spectral Index）：高低頻比
- POP（破泡事件率）
- FLOW（光流不一致度）

**實現模塊：** `FeatureExtractor`
**文件位置：** `src/aqua_feeder/vision/feature_extractor.py`

**核心功能：**
```python
def extract_features(self, rois):
    """對應需求書的特徵提取"""
    features = {}
    
    # 動態能量 (Motion Energy)
    features['ME'] = self._extract_motion_energy(rois['roi_ring'])
    
    # 波紋頻譜指數 (Ripple Spectral Index)
    features['RSI'] = self._extract_ripple_spectral_index(rois['roi_ring'])
    
    # 破泡事件率 (Bubble Pop Events)
    features['POP'] = self._extract_bubble_pop_events(rois['roi_bub'])
    
    # 光流不一致度 (Optical Flow Inconsistency)
    features['FLOW'] = self._extract_optical_flow_inconsistency(rois['roi_ring'])
    
    return features
```

### 3. 特徵融合模塊

**需求書要求：**
- 融合函數：H = α·RSI + β·POP + γ·FLOW − δ·ME_ring
- 參數 α, β, γ, δ 可調

**實現位置：** `FeedingController._calculate_activity_index()`
**文件位置：** `src/aqua_feeder/control/feeding_controller.py`

**核心功能：**
```python
def _calculate_activity_index(self, features):
    """對應需求書的特徵融合"""
    # 提取並正規化特徵
    RSI = min(features.get('RSI', self.RSI0) / self.RSI_max, 1.0)
    POP = min(features.get('POP', 0.0) / self.POP_max, 1.0)
    FLOW = min(features.get('FLOW', 0.0) / self.FLOW_max, 1.0)
    ME_ring = min(features.get('ME_ring', self.ME0) / self.ME_max, 1.0)
    
    # 融合計算 - 完全符合需求書公式
    H = self.alpha * RSI + self.beta * POP + self.gamma * FLOW - self.delta * ME_ring
    
    return max(0.0, min(1.0, H))
```

### 4. 控制器模塊

**需求書要求：**
- 分段控制（H_hi/H_lo）
- PI控制器（Kp, Ki）
- 斜率限制 Δup, Δdown
- Anti-windup（反積分）

**實現模塊：** `FeedingController` + `PIController`
**文件位置：** 
- `src/aqua_feeder/control/feeding_controller.py`
- `src/aqua_feeder/control/pi_controller.py`

**核心功能：**
```python
# 分段控制
def _update_state_machine(self, H, current_time):
    """對應需求書的分段控制"""
    if self.state == FeedingState.EVALUATING:
        # 使用H_hi/H_lo門檻判斷
        if H >= self.H_hi:
            # 高活躍度處理
        elif H <= self.H_lo:
            # 低活躍度處理

# PI控制器
def update(self, setpoint, measured_value):
    """對應需求書的PI控制"""
    error = setpoint - measured_value
    
    # 比例項
    proportional = self.kp * error
    
    # 積分項 + Anti-windup
    self.integral += error * dt
    if self.anti_windup:
        self.integral = max(-self.max_integral, 
                           min(self.max_integral, self.integral))
    
    output = proportional + self.ki * self.integral
    
    # 斜率限制 Δup, Δdown
    delta = output - self.current_pwm
    if delta > 0:
        delta = min(delta, self.delta_up)
    else:
        delta = max(delta, -self.delta_down)
```

### 5. 異常檢測模塊

**需求書要求：**
- FPS < 門檻 → 切換保守模式
- H 長期低 → 延長 t_eval 或暫停餵食

**實現位置：** `FeedingController._check_anomalies()`

**核心功能：**
```python
def _check_anomalies(self, features, fps, current_time):
    """對應需求書的異常檢測"""
    # 檢查FPS過低
    fps_threshold = self.anomaly_config.get('fps_threshold', 50)
    if fps < fps_threshold:
        # 切換至異常模式
        self.state = FeedingState.ANOMALY
    
    # 檢查持續低活躍度
    H = self._calculate_activity_index(features)
    if H < self.H_lo * 0.5:  # 極低活躍度
        # 延長評估時間
        extension = self.anomaly_config.get('evaluation_extension', 2.0)
        self.t_eval = self.t_eval * extension
```

### 6. 記錄與日誌模塊

**需求書要求：**
- CSV：ts, state, pwm, H, RSI, POP, FLOW, ME_ring, warnings
- 日報產出：折線圖（H vs PWM）、異常標註

**實現模塊：** `ControlNode.log_data()` + `SystemValidator`
**文件位置：** 
- `src/aqua_feeder/control/control_node.py`
- `src/aqua_feeder/validation/system_validator.py`

## 三、主要參數與配置對應

### 參數配置文件
**文件位置：** `config/system_params.yaml`

**需求書參數完整對應：**

```yaml
# 控制器參數 - 完全符合需求書
controller:
  timing:
    t_feed: 0.6      # 餵食時間窗，初始 0.6s
    t_eval: 3.0      # 評估時間窗，初始 3.0s
    t_settle: 1.0    # 穩定等待時間
    
  thresholds:
    H_hi: 0.65       # 高活躍度門檻
    H_lo: 0.35       # 低活躍度門檻
    
  pi_controller:
    Kp: 15.0         # 比例增益
    Ki: 2.0          # 積分增益
    
  constraints:
    delta_up: 10.0   # PWM每次最大上升幅度
    delta_down: 15.0 # PWM每次最大下降幅度

# 硬體參數 - 符合需求書規格
hardware:
  pwm:
    min_duty_cycle: 20  # PWM最小值 20%
    max_duty_cycle: 70  # PWM最大值 70%
    
  camera:
    resolution: [1920, 1080]  # 1080p
    fps: 60                   # 60fps

# 特徵融合權重 - 對應需求書公式
feature_fusion:
  weights:
    alpha: 0.4   # RSI權重
    beta: 0.3    # POP權重
    gamma: 0.2   # FLOW權重
    delta: 0.1   # ME_ring權重（負貢獻）
```

## 四、驗證方式與目標效果實現

### 驗證模塊實現
**實現模塊：** `SystemValidator`
**文件位置：** `src/aqua_feeder/validation/system_validator.py`

### 1. 相關係數驗證
**需求書目標：** r(airflow, H) ≥ 0.75

```python
def validate_correlation(self, csv_file, airflow_data):
    """驗證活躍度H與氣泡盤檔位的相關係數"""
    correlation, p_value = stats.pearsonr(airflow_data, df['H'])
    is_passed = correlation >= 0.75  # 需求書目標
    return result
```

### 2. PWM振盪檢查
**需求書目標：** PWM振盪幅度 ≤ ±15%（10迴合內）

```python
def validate_pwm_oscillation(self, csv_file, time_window=10):
    """驗證PWM振盪幅度"""
    # 計算10迴合內的振盪幅度
    max_oscillation = max(oscillations)
    is_passed = max_oscillation <= 15.0  # 需求書目標
    return result
```

### 3. 命中率分析
**需求書目標：** T_disappear命中率 ≥ 70%

```python
def validate_disappearance_hit_rate(self, csv_file, target_range=(2.0, 5.0)):
    """驗證T_disappear命中率"""
    hit_rate = hits / len(feeding_cycles)
    is_passed = hit_rate >= 0.70  # 需求書目標
    return result
```

### 4. 反應時間檢測
**需求書目標：** 故障降級反應時間 ≤ 1s

```python
def validate_response_time(self, csv_file):
    """驗證故障降級反應時間"""
    max_response_time = max(anomaly_transitions)
    is_passed = max_response_time <= 1.0  # 需求書目標
    return result
```

## 五、系統架構與啟動流程

### ROS2節點架構
```
aqua_feeder_main_controller (主控制器)
├── hardware_node (硬體節點)
│   ├── camera_interface (相機接口)
│   ├── pwm_controller (PWM控制器)
│   └── gpio_controller (GPIO控制器)
├── vision_node (視覺節點)
│   ├── image_processor (影像處理器)
│   └── feature_extractor (特徵提取器)
├── control_node (控制節點)
│   ├── feeding_controller (餵料控制器)
│   └── pi_controller (PI控制器)
└── validation (驗證模塊)
    └── system_validator (系統驗證器)
```

### 啟動流程
```bash
# 1. 安裝系統
bash install.sh

# 2. 啟動完整系統
python start_system.py

# 3. 或分別啟動各節點
ros2 launch aqua_feeder aqua_feeder_launch.py
```

## 六、文件組織結構

```
aquaFeederAutoAdj/
├── config/
│   └── system_params.yaml          # 系統參數配置
├── src/aqua_feeder/
│   ├── vision/                     # 視覺處理模塊
│   │   ├── image_processor.py      # 影像前處理
│   │   ├── feature_extractor.py    # 特徵提取
│   │   └── vision_node.py          # 視覺ROS2節點
│   ├── control/                    # 控制模塊
│   │   ├── pi_controller.py        # PI控制器
│   │   ├── feeding_controller.py   # 餵料控制器
│   │   └── control_node.py         # 控制ROS2節點
│   ├── hardware/                   # 硬體接口模塊
│   │   ├── camera_interface.py     # 相機接口
│   │   ├── pwm_controller.py       # PWM控制器
│   │   ├── gpio_controller.py      # GPIO控制器
│   │   └── hardware_node.py        # 硬體ROS2節點
│   ├── validation/                 # 驗證模塊
│   │   └── system_validator.py     # 系統驗證器
│   └── main_controller.py          # 主控制器
├── launch/
│   └── aqua_feeder_launch.py       # ROS2啟動文件
├── logs/                           # 日誌輸出目錄
├── docs/                           # 文檔目錄
├── tests/                          # 測試文件
├── README.md                       # 項目說明
├── install.sh                      # 安裝腳本
└── start_system.py                 # 系統啟動腳本
```

## 七、總結

本系統完全按照軟體需求書的規格實現，所有功能模塊都有明確的對應關係：

1. **硬體物料清單** → 對應的軟體驅動模塊
2. **軟體功能模塊** → 完整實現所有6大模塊
3. **參數設計** → 參數配置文件完全對應
4. **驗證方式** → 驗證模塊實現所有4項驗證目標

系統採用模塊化設計，便於維護和擴展，完全符合需求書的技術規格和性能要求。
